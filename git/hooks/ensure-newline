#!/bin/bash

# ステージされた追加/変更ファイル一覧を取得
files=$(git diff --cached --name-only --diff-filter=AM)

# textfmt がなければ exit
if ! command -v textfmt &>/dev/null; then
    echo "textfmt could not be found"
    echo "go install github.com/naoyafurudono/textfmt@latest"
    exit 1
fi

# 末尾改行を補完する処理
for f in $files; do
    # 自動生成されたファイルかどうかをチェック
    is_autogenerated=$(git check-attr linguist-generated -- "$f" | grep -c "linguist-generated: true")
    
    # ファイルが存在し、テキストファイルで、自動生成されたファイルでない場合のみ処理
    if [ -f "$f" ] && git grep -Iq . -- "$f" ] && [ "$is_autogenerated" -eq 0 ]; then
        textfmt "$f"
        git add "$f" # 修正をステージに追加
    fi
done

exit 0 # 通常のコミット続行
